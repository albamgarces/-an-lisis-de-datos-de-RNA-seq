---
title: "PEC2-Análisis de Datos de Ultrasecuenciación"
subtitle: "Análisis de Datos Ómicos"
author: "Alba Moya Garcés"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: 
  pdf_document:
    toc: yes
    toc_depth: 4
    fig_caption: yes
    number_sections: true
urlcolor: blue
nocite: |
  @*
bibliography: biblio_PEC2.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment=FALSE, cache=TRUE, warning=FALSE, message=FALSE, fig.width = 7, fig.height = 7, fig.cap = TRUE)
```


```{r require_packages}
require(rstudioapi)

```

#Pipeline

1. Definición de los datos tal como se ha descrito en el párrafo anterior
2. Preprocesado de los datos: filtraje y normalización
3. Identificación de genes diferencialmente expresados
4. Anotación de los resultados
5. Busca de patrones de expresión y agrupación de las muestras (comparación entre las
distintas comparaciones).
6. Análisis de significación biológica (“Gene Enrichment Analysis”)

#Abstract
#Objetivos
#Material

El código completo para desarrollar este análisis, o cualquier otro a partir de su adaptación, puede descargarse del siguiente repositorio de *GitHub*:

[https://github.com/albamgarces/analisis-de-datos-de-RNA-seq.git](https://github.com/albamgarces/analisis-de-datos-de-RNA-seq.git). 

##Software


Se realizó este análisis utilizando el lenguaje `r version$version.string` R en la interfaz RStudio versión 1.1.456 y las librerías desarrolaldas para este tipo de análisis por el proyecto Bioconductor.
El programa estadístico R se puede descargar desde la página web del [proyecto CRAN](https://cran.r-project.org/index.html) (The Comprehensive R Archive Network) siguiendo las indicaciones.
R-Studio puede descargarse desde su página web <https://www.rstudio.com/>.

Finalmente, las librerías adicionales necesarias para llevar a cabo este análisis se obtuvieron del proyecto Bioconductor versión `r BiocManager::version()`, el cuál se instala junto con algunos paquetes básicos mediante el siguiente código:

```{r BioconductorInstalling, echo=TRUE}
if (!requireNamespace("BiocManager", quietly = TRUE))
     install.packages("BiocManager")
BiocManager::install()
```

##Datos

Los archivos `counts.csv` y `targets.csv`contienen la información de un estudio obtenido del repositorio del proyecto  [GTEx](https://www.gtexportal.org/home/) (Genotype-Tissue Expression). Encontramos los datos de expresión (RNA-seq) pertenecientes a un análisis del tiroide donde se comparan tres tipos de infiltración en 292 muestras:

- tejidos no infiltrados (NIT): 236 muestras
- infiltración focalizada (SFI): 42 muestras
- infiltración linfoide extensiva (ELI): 14 muestras



#Métodos

## Preparación del área de trabajo:

Para llevar a cabo el análisis, se debe gestionar una gran cantidad de archivos entre aquesllos que ocupan los datos originales y los generados durante su análisis. Es por ello que siempre se debería comenzar creando als carpetas necesarias para simplificar la ruta de trabajo. Se recomienda generar una **carpeta principal** con el nombre de nuestro proyecto en cuyo interior alojaremos una carpeta con los archivos de **datos** y otra con los **resultados** generados del análisis

Estas carpetas las genereamos rápidamente desde el explorador de archivos o la consola de cualquiera de los sistemas operativos usuales. Desde R también podemos generar estas subcarpetas mediante el siguiente código:


```{r Carpetas, eval=FALSE, echo=TRUE}
setwd(".")
dir.create("data")
dir.create("results")
```



##Instalación de paquetes en R

A continuación se muestran los paquetes necesarios fpara este estudio que requieren instalación:

```{r instalacionPaquetes, echo=TRUE}
#para que salgan los que están en curso: (.packages())
# UNCOMMENT IF INSTALL REQUIRES
##install.packages("readr")
##install.packages("sampling")
## install.packages("knitr")
#install.packages("cluster")
# install.packages("gplots")
## install.packages("ggplot2")
# install.packages("ggrepel")
# install.packages("BiocManager")
# BiocManager::install("oligo")
# BiocManager::install("arrayQualityMetrics")
# BiocManager::install("pvca")
# BiocManager::install("pacman")
# BiocManager::install("geneplotter")
# BiocManager::install("org.Dm.eg.db")
# BiocManager::install("limma")
# BiocManager::install("genefilter")
# BiocManager::install("drosophila2.db")
# BiocManager::install("ReactomePA")
```

```{r required_packages}
kable(.packages())
```

##Lectura y selección de los datos

Importamos los archivos proporcionados a R. 
El archivo `targets` contiene las 292 muestras identificadas por un número según sean provenientes de tejidos NIT (1), SFI (2) o ELI (3).

```{r read_targets}
targets <- read.csv("data/targets.csv", head=T)
kable(head(targets[,c(3,4,6,7,8)]), caption = "Fragmento de la tabla de datos `targets`")
```

El archivo `counts` contempla las 292 muestras como variables y nos informa del número de veces que se ha detectado cada uno de los 56202 genes identificados en la primera columna. 

```{r read_counts, fig.cap= "Fragmento de la tabla de datos count"}
counts <- read.csv2("data/counts.csv", head=T, row.names = 1)
kable(head(counts[,1:2]), caption = "Fragmento de la tabla de datos `count`")
```

Con el fin de simplificar el análisis, se decidió seleccionar aleatoriamente 10 muestras de cada tipo de tejido. El código para realizar esta estracción es el que se indica a caontinuación.

```{r select_samples, echo=TRUE}
library(sampling)
library(knitr)
#selección de muestras en el archivo targets
set.seed(1234)
selected <- strata(targets, c("Group"), size=c(10,10,10), method = "srswor")
muestreo <- getdata(targets, selected)
muestreo <- muestreo[,1:10]
```

```{r selected_table}
kable(muestreo[,c(3,6,7,9)], caption = "Selección de diez muestras de cada tipo")
```


```{r select_count, echo=TRUE}
#selección de muestras en el archivo counts
count_subset <- counts[, c(muestreo$ID_unit)]
```



```{r counts_selected_table}
condition <- c("NIT","NIT","NIT","NIT","NIT","NIT","NIT","NIT","NIT", "NIT","ELI","ELI","ELI","ELI","ELI","ELI","ELI","ELI","ELI","ELI","SFI","SFI","SFI","SFI","SFI","SFI","SFI","SFI","SFI","SFI")
colnames(count_subset)<- paste0(condition,1:10)
kable(count_subset[1:5,1:3], caption = "Fragmento tabla counts de muestras seleccionadas")
```


Con los datos de conteo de estas 30 muestras seleccionadas continuaremos el resto del análisis.

##Control de calidad de los datos

La evaluación de la calidad de los datos es esencial para cualquier tipo de análisis de datos. Esto nos permitirá detectar errores técnicos que puedan manifestarse en la toma de datos para poder detectar los genes expresados diferencialmente.

### Transformación de los datos

PAra oder explorar y visualizar los datos en su conjunto, es esencial tener todos los valores en una escala comparable. Transformaremos los datos a escala $log_2$ para normalizar las distribuciones. Se utiliza este método de transformación porque facilita su conversión a la escala original.

Tal y como recomienda González (Toulouse, 2014), sumaremos 1 a cada registro de conteo para evitar los valores 0 de algunas condiciones:

$$y=log_2(K+1)$$
```{r log2}
log2_count <- log2(count_subset+1)
```

Podemos ver el efecto de la transformación de los datos tomando de ejemplo una de las muestras
```{r histogram,  fig.cap="Distribución de las expresiones de una de las muestras de tejido NIT. Podemos ver el efecto de la transformación de los datos mediante log(2)+1"}
par(mfrow=c(1,2))
hist(count_subset$NIT1, col="red", main="Distribución tejidos NIT")
hist(log2_count$NIT1, col="blue", main="Distribución log(2)+1 tejidos NIT")
```
### Gráfico de densidad

El gráfico de densidad de Kernel nos permitirá hacernos una idea de la similiritud entre las diferentes distribuciones.


```{r}
ggplot(df,aes(x=value, colour=Samples, fill =Samples))+
  ylim(c(0, 0.25))+
  geom_density(alpha = 0.2, size = 1.25) + 
  facet_wrap (df$Condition) +
  xlab(expression(log[2](counts + 1)))+
  theme(legend.position = "none")
```


#### Boxplot

```{r boxplot, fig.cap="Diagrama de cajas que muestran la distribución de los diferentes tipos de tejido. Se puede observar cierta heterogeneidad, sobretodo en la muestra 7 del tipo tisular NIT, pero no parece que sea sistemática ni que sea producido por muestras defectuosas."}
require(reshape2)
require(ggplot2)
colores <- c(rep("yellow", 10), rep("blue", 10), rep("red", 10))
df=melt(log2_count, variable.name = "Samples")
df=data.frame(df, Condition=substr(df$Samples,1, 30))
ggplot(df, aes(x=Samples, y =value, fill=Condition ))+
  geom_boxplot()+
  xlab("")+
  ylab(expression(log[2](counts+1)))+
  scale_fill_manual(values=colores)+
  theme(legend.position = "none", axis.text = element_text(size = 5))
```

```{r boxplots, fig.cap="Diagrama de cajas que muestran la distribución de los diferentes tipos de tejido. Se puede observar cierta heterogeneidad, sobretodo en la muestra 7 del tipo tisular NIT, pero no parece que sea sistemática ni que sea producido por muestras defectuosas."}
# 
# par(mfrow=c(2,2))
# boxplot(log2_count[, 1:10], col="green", main="Diagrama de cajas tejido NIT")
# boxplot(log2_count[, 11:20], col="blue", main="Diagrama de cajas tejido ELI")
# boxplot(log2_count[, 21:30], col="red", main="Diagrama de cajas tejido SFI")
```







#Resultados
#Discusión
#Bibliografía